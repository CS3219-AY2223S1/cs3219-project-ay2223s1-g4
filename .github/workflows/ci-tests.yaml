name: Run CI Tests

on: workflow_dispatch

## TODO (1) find a way to load all .env files as secrets
## TODO (2) determine docker images neeeded
## - mongodb
## - nodejs
## - mysql
## - poetry
# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     types: [opened, reopened]
#     branches:
#       - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Pull repository
      uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14.x'

    - name: Run backend tests
      env:
        MONGODB_URI: ${{ secrets.mongodb_path }}
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 5
        max_attempts: 10
        retry_wait_seconds: 15
        command: |
          ./run-backend.sh b
          ./run-tests
